!function(global,factory){"object"==typeof exports&&"undefined"!=typeof module?factory(exports):"function"==typeof define&&define.amd?define("@microsoft/mezzurite-core",["exports"],factory):factory(global.mezzuriteCore={})}(this,function(exports){"use strict";var MezzuriteConstants={mezzuriteObjectVersion:"1.0.0",captureCycleTimeout:1e4,slowestResourceTimeout:4e3,idLength:6,domAttributeName:"perf-id",measureNamePrefix:"mz",altName:"ALT",vltName:"VLT",fvltName:"FVLT",vltMarkStart:"VltStart",altMarkStart:"AltStart",altMarkEnd:"AltEnd",componentMarkStart:"ComponentStart",componentMarkEnd:"ComponentEnd",componentMarkRenderStart:"ComponentRenderStart",jsllConfigName:"jsll",versionName:"MezzuriteVersion",allComponents:"AllComponents",redirect:"Redirect",sessionData:"MezzuriteSession",fullNamePartTitle:"title",fullNamePartKey:"key",unsupportedBrowserName:"unsupportedBrowser",unsupportedBrowserPerf:"This was sent from a client using a browser that does not support the Performance API"},MezzuriteObject=function(){this.firstViewLoaded=!1,this.captureCycleStarted=!1,this.routerPerf=!1,this.measures=[],this.defaultLogs=[],this.childElementNames={},this.slowestResource={},this.currentComponents={},this.vltComponentLookup={},this.elementLookup={}},MezzuriteUtils=function(){function MezzuriteUtils(){}return MezzuriteUtils.createMezzuriteObject=function(obj){this.addCustomEventPolyfill();var mzObj=new MezzuriteObject;for(var prop in mzObj)void 0===obj[prop]&&(obj[prop]=mzObj[prop])},MezzuriteUtils.testReset=function(){var obj=window.mezzurite;obj.childElementNames={},obj.slowestResource={},obj.currentComponents={},obj.vltComponentLookup={},obj.elementLookup={},window.mezzurite=obj},MezzuriteUtils.makeId=function(){for(var text="",possible="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",i=0;i<MezzuriteConstants.idLength;i++)text+=possible.charAt(Math.floor(Math.random()*possible.length));return text},MezzuriteUtils.getFunctionName=function(fun){var ret=fun.toString();return ret=(ret=ret.substr("function ".length)).substr(0,ret.indexOf("("))},MezzuriteUtils.getDisplayName=function(WrappedComponent){return void 0!==WrappedComponent.name?WrappedComponent.name:MezzuriteUtils.getFunctionName(WrappedComponent)},MezzuriteUtils.getName=function(name,key){return MezzuriteConstants.measureNamePrefix+";"+name+";"+key},MezzuriteUtils.createMetric=function(metricType,value,data){void 0===data&&(data=null);var obj={metricType:metricType,value:value%1!=0?parseFloat(value.toFixed(1)):value};return null!==data&&(obj.data=JSON.stringify(data)),obj},MezzuriteUtils.walkDOM=function(node,key,func){for(func(node,key),node=node.firstChild;node;)MezzuriteUtils.walkDOM(node,key,func),node=node.nextSibling},MezzuriteUtils.getFullNamePart=function(fullName,val){var arr=fullName.split(";");switch(val){case MezzuriteConstants.fullNamePartTitle:return arr[1];case MezzuriteConstants.fullNamePartKey:return arr[2];default:return fullName}},MezzuriteUtils.addCustomEventPolyfill=function(){if("function"==typeof window.CustomEvent)return!1;function CustomEvent(event,params){params=params||{bubbles:!1,cancelable:!1,detail:void 0};var evt=document.createEvent("CustomEvent");return evt.initCustomEvent(event,params.bubbles,params.cancelable,params.detail),evt}CustomEvent.prototype=window.Event.prototype,window.CustomEvent=CustomEvent},MezzuriteUtils}(),MezzuriteMeasure=function(){},PerformanceTimingService=function(){function PerformanceTimingService(){}return PerformanceTimingService.measure=function(name,slowestResource,maxComponentEndTime){var startEntry,endEntry;void 0===slowestResource&&(slowestResource=null),void 0===maxComponentEndTime&&(maxComponentEndTime=null);var componentTitle=MezzuriteUtils.getFullNamePart(name,MezzuriteConstants.fullNamePartTitle),key=MezzuriteUtils.getFullNamePart(name,MezzuriteConstants.fullNamePartKey);if(void 0!==name){endEntry=componentTitle===MezzuriteConstants.altName?performance.getEntriesByName(MezzuriteConstants.altMarkEnd)[0]:componentTitle===MezzuriteConstants.vltName?(startEntry=performance.getEntriesByName(MezzuriteConstants.vltMarkStart)[0],{startTime:maxComponentEndTime}):(startEntry=performance.getEntriesByName(key+MezzuriteConstants.componentMarkStart)[0],performance.getEntriesByName(key+MezzuriteConstants.componentMarkEnd)[0]);var renderStartEntry=performance.getEntriesByName(key+MezzuriteConstants.componentMarkRenderStart)[0],startTime=void 0!==startEntry?startEntry.startTime:0,endTime=endEntry.startTime;null!==slowestResource&&slowestResource.responseEnd>endTime&&(endTime=slowestResource.responseEnd);var mountDuration=endEntry.startTime-startTime,totalDuration=endTime-startTime,nameArr=name.split(";"),obj=new MezzuriteMeasure;obj.name=nameArr[1],obj.id=nameArr[2],obj.startTime=startTime%1!=0?parseFloat(startTime.toFixed(1)):startTime,obj.endTime=parseFloat(endTime.toFixed(1)),obj.untilMount=parseFloat(mountDuration.toFixed(1)),obj.clt=parseFloat(totalDuration.toFixed(1)),obj.slowResource={},slowestResource&&slowestResource.responseEnd>=startTime?(obj.slowResource.endTime=parseFloat(slowestResource.responseEnd.toFixed(1)),obj.slowResource.name=slowestResource.name):null!==slowestResource&&(obj.slowResource.endTime=-1,obj.slowResource.name=slowestResource.name),componentTitle!==MezzuriteConstants.altName&&componentTitle!==MezzuriteConstants.vltName&&renderStartEntry&&(obj.renderStartTime=renderStartEntry.startTime),window.mezzurite.measures.push(obj)}},PerformanceTimingService.getMeasuresByName=function(name){var result=[];if(null==name)return null;for(var measures=window.mezzurite.measures,i=0;i<measures.length;i++)name===measures[i].name&&result.push(measures[i]);return result},PerformanceTimingService.getMeasureById=function(id){if(null==id)return null;for(var measures=window.mezzurite.measures,i=0;i<measures.length;i++)if(id===measures[i].id)return measures[i];return null},PerformanceTimingService.getMeasureByNameAndId=function(name,id){if(null==name||null==id)return null;for(var measures=window.mezzurite.measures,i=0;i<measures.length;i++)if(name===measures[i].name&&id===measures[i].id)return measures[i];return null},PerformanceTimingService.getCurrentComponents=function(){return window.mezzurite.measures.filter(function(m){return-1===m.name.indexOf(MezzuriteConstants.measureNamePrefix+";"+MezzuriteConstants.altName)&&-1===m.name.indexOf(MezzuriteConstants.measureNamePrefix+";"+MezzuriteConstants.vltName)&&m.startTime>=window.mezzurite.startTime&&m.startTime<=window.mezzurite.endTime})},PerformanceTimingService.getCurrentComponentsLookup=function(){for(var components=window.mezzurite.measures.filter(function(m){return-1===m.name.indexOf(MezzuriteConstants.measureNamePrefix+";"+MezzuriteConstants.altName)&&-1===m.name.indexOf(MezzuriteConstants.measureNamePrefix+";"+MezzuriteConstants.vltName)&&m.startTime>=window.mezzurite.startTime&&m.startTime<=window.mezzurite.endTime}),obj={},i=0;i<components.length;i++)obj[MezzuriteConstants.measureNamePrefix+";"+components[i].name+";"+components[i].id]=components[i];return obj},PerformanceTimingService.calculateVlt=function(){var measure,maxComponent=null,vltComponents=[],components=this.getCurrentComponentsLookup(),vltLookup=window.mezzurite.vltComponentLookup;for(var key in vltLookup)if(components[key]&&!0===vltLookup[key])if(vltComponents.push(components[key]),null!==maxComponent){var slowestResource=window.mezzurite.slowestResource[key];null!=slowestResource&&slowestResource.responseEnd,maxComponent.clt+maxComponent.startTime<components[key].clt+components[key].startTime&&(maxComponent=components[key])}else maxComponent=components[key];if(null===maxComponent)return null;var fullName=MezzuriteConstants.measureNamePrefix+";"+MezzuriteConstants.vltName+";"+maxComponent.id;return this.measure(fullName,null,maxComponent.endTime),measure=this.getMeasureByNameAndId(MezzuriteConstants.vltName,maxComponent.id),performance.clearMarks(MezzuriteConstants.vltMarkStart),{vlt:measure.clt,components:vltComponents}},PerformanceTimingService.getElNames=function(el,key){void 0===window.mezzurite.childElementNames[key]&&(window.mezzurite.childElementNames[key]=[]),"IMG"===el.tagName&&window.mezzurite.childElementNames[key].push(el.src)},PerformanceTimingService.calculateSlowestResource=function(el,fullName){var key=MezzuriteUtils.getFullNamePart(fullName,MezzuriteConstants.fullNamePartKey),slowestResource=null;MezzuriteUtils.walkDOM(el,key,this.getElNames);var resources=performance.getEntriesByType("resource").filter(function(r){return"img"===r.initiatorType}),currentResources=window.mezzurite.childElementNames[key];if(0!==resources.length){for(var i=0;i<currentResources.length;i++)for(var j=0;j<resources.length;j++)currentResources[i]===resources[j].name&&(null===slowestResource||resources[j].responseEnd>slowestResource.responseEnd)&&(slowestResource=resources[j]);return window.mezzurite.slowestResource[fullName]=slowestResource}},PerformanceTimingService.calculateSlowestResourceBatch=function(){var slow,elementDict=window.mezzurite.elementLookup;for(var prop in elementDict)null===(slow=this.calculateSlowestResource(elementDict[prop],prop))?PerformanceTimingService.measure(prop):PerformanceTimingService.measure(prop,slow)},PerformanceTimingService}(),PerformanceTelemetryService=function(){function PerformanceTelemetryService(){}return PerformanceTelemetryService.startCaptureCycle=function(){window.mezzurite.captureCycleStarted||(window.mezzurite.startTime=window.performance.now(),window.mezzurite.captureCycleStarted=!0,window.mezzurite.captureTimer=setTimeout(function(){PerformanceTelemetryService.captureTimings()},MezzuriteConstants.captureCycleTimeout))},PerformanceTelemetryService.captureTimings=function(isRedirect){void 0===isRedirect&&(isRedirect=!1),clearTimeout(window.mezzurite.captureTimer),window.mezzurite.endTime=window.performance.now(),window.mezzurite.captureCycleStarted||(window.mezzurite.captureCycleStarted=!0),PerformanceTelemetryService.submitTelemetry(isRedirect),window.mezzurite.captureCycleStarted=!1},PerformanceTelemetryService.submitTelemetry=function(isRedirect){var timings=[];timings.push(MezzuriteUtils.createMetric(MezzuriteConstants.redirect,!1===isRedirect?0:1)),window.mezzurite.elementLookup!=={}&&PerformanceTimingService.calculateSlowestResourceBatch();var components=PerformanceTimingService.getCurrentComponents();if(window.mezzurite.routerPerf){if(!1===window.mezzurite.firstViewLoaded){var altMeasure=window.mezzurite.measures.filter(function(m){return-1<m.name.indexOf(MezzuriteConstants.altName)})[0];timings.push(MezzuriteUtils.createMetric(MezzuriteConstants.altName,altMeasure.clt)),window.mezzurite.firstViewLoaded=!0}if(0<components.length){var vltResults=PerformanceTimingService.calculateVlt();null!==vltResults&&timings.push(MezzuriteUtils.createMetric(MezzuriteConstants.vltName,vltResults.vlt,vltResults.components))}0===components.length&&performance.clearMarks(MezzuriteConstants.vltMarkStart)}0<components.length&&timings.push(MezzuriteUtils.createMetric(MezzuriteConstants.allComponents,-1,components)),this.log(timings),MezzuriteUtils.testReset()},PerformanceTelemetryService.log=function(timings){if(window.mezzurite)if(1<timings.length){var obj={Timings:timings,Framework:{name:window.mezzurite.packageName,version:window.mezzurite.packageVersion},ViewportWidth:window.mezzurite.viewportWidth,ViewportHeight:window.mezzurite.viewportHeight,ObjectVersion:MezzuriteConstants.mezzuriteObjectVersion};-1<window.location.href.indexOf("localhost")&&console.log("to log for testing: ",obj),window.mezzurite.EventElement&&window.mezzurite.EventElement.dispatchEvent(new CustomEvent("Timing",{detail:obj}))}else console.log("nothing for Mezzurite to log.")},PerformanceTelemetryService.compatibilityCheck=function(){var isCompatible=void 0!==window.performance;if(!isCompatible){var timings=[MezzuriteUtils.createMetric(MezzuriteConstants.unsupportedBrowserName,-1,MezzuriteConstants.unsupportedBrowserPerf)];this.log(timings)}return isCompatible},PerformanceTelemetryService}(),PerfMetric=function(){};exports.PerformanceTelemetryService=PerformanceTelemetryService,exports.PerformanceTimingService=PerformanceTimingService,exports.PerfMetric=PerfMetric,exports.MezzuriteConstants=MezzuriteConstants,exports.MezzuriteUtils=MezzuriteUtils,Object.defineProperty(exports,"__esModule",{value:!0})});